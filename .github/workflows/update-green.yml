name: Auto-update Friday (Green Bin) JSON

on:
  schedule:
    - cron: "0 12 * * *"   # runs daily at 12:00 UTC
  workflow_dispatch:

jobs:
  update-green:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer
        run: npm install puppeteer@21

      - name: Scrape Green Bin routes (Brue + Barvas)
        run: |
          node - <<'EOF'
          import puppeteer from "puppeteer";
          import fs from "fs";

          const URL =
            "https://www.cne-siar.gov.uk/bins-and-recycling/waste-recycling-collections-lewis-and-harris/glass-green-bin-collections/friday-collections";

          const ROUTES = [
            {
              key: "brue",
              title: "Brue to Carloway",
              coverage: ["Brue", "Arnol", "Bragar", "Shawbost", "Carloway"],
            },
            {
              key: "barvas",
              title: "Barvas to Galson",
              coverage: [
                "Barvas",
                "Ballantrushal",
                "Shader",
                "Airidhantuim",
                "Borve",
                "High Borve",
                "Melbost Borve",
                "South Galson",
                "North Galson",
                "Water Board Houses",
                "An Allt Dubh",
              ],
            },
          ];

          const browser = await puppeteer.launch({
            headless: true,
            args: ["--no-sandbox"],
          });

          const page = await browser.newPage();
          await page.goto(URL, { waitUntil: "networkidle2", timeout: 120000 });

          // Expand all accordion sections
          await page.evaluate(() => {
            document
              .querySelectorAll(".accordion-pane__title button")
              .forEach(btn => btn.click());
          });

          await page.waitForTimeout(3000);

          const results = await page.evaluate((ROUTES) => {
            const out = [];

            document.querySelectorAll(".accordion-pane").forEach(pane => {
              const title =
                pane.querySelector(".accordion-pane__title button")
                  ?.textContent?.trim();

              const route = ROUTES.find(r => r.title === title);
              if (!route) return;

              const dates = Array.from(pane.querySelectorAll("ol li"))
                .map(li => li.textContent.trim())
                .filter(Boolean);

              if (dates.length) {
                out.push({
                  key: route.key,
                  area: route.title,
                  dates: [...new Set(dates)],
                  coverage: route.coverage,
                });
              }
            });

            return out;
          }, ROUTES);

          await browser.close();

          if (!results.length) {
            throw new Error("No green bin routes found — CNES page may have changed");
          }

          fs.writeFileSync(
            "green.json",
            JSON.stringify(
              {
                lastUpdated: new Date().toISOString(),
                results,
              },
              null,
              2
            )
          );

          console.log(
            "✅ Green bin routes saved:",
            results.map(r => r.area).join(", ")
          );
          EOF

      - name: Commit and push updates
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git pull --rebase origin main || true
          git add green.json
          git commit -m "Auto-update Green bin JSON ($(date -u))" || echo "No changes"
          git push
